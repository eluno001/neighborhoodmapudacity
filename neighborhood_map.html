<!DOCTYPE html>
<html>
<head>
	<title>Painting workshops in the 14th district - Paris</title>
	<style type="text/css">
		html, body { height: 100%; margin: 0; padding: 0; }
		#map { height: 100%; }
		.container-fluid, .row {height: 100%; }
		#pano {
			height: 200px;
			width: 200px;
		}
	</style>
	<script type="text/javascript" src="js/knockout-3.4.2.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div id="listView" class="col-md-2">
				<input data-bind="value: searched, valueUpdate: 'afterkeydown'">
					<ul data-bind="foreach: markersToShow">
						<li data-bind="text: title, attr: { id: id}"></li>
					</ul>
				</div>
				<!-- Create a div to contain the map -->
				<div id="map" class="col-md-10"></div>
			</div>
		</div>
		<script>
			// We create a map variable
			var map;

			// we create an infowindow global variable
			var workshopInfoWindow;

			// We create a list for all the locations. I could not get it to work
			// in the view model when I did not declare it as an observable.
			var markers = ko.observableArray([]);

			// We create a JS function to manipulate the map
			function initMap(){
				map = new google.maps.Map(document.getElementById('map'), {
					center: {lat: 48.8331, lng: 2.3264},
					zoom: 14,
					mapTypeControl: false,
				});

				workshopInfoWindow = new google.maps.InfoWindow();
				var bounds = new google.maps.LatLngBounds();

				// This is the data relative to the workshops that we will displaying
				// on the map.
				var workshops = [
					{name: 'Ateliers Terre Et Feu', location: {lat: 48.828278, lng: 2.323281100000031}, website: 'http://www.terre-et-feu.com/paris-14/'},
					{name: 'Atlier Baroque', location: {lat: 48.828577, lng: 2.3302197}, website: 'http://www.atelier-baroque.fr/'},
					{name: "Poudre d'Ã©veil", location: {lat: 48.8325271, lng: 2.3228047}, website: 'http://www.atelier-arts-plastiques-paris14.fr/'},
					{name: 'Workshop Vermeer', location: {lat: 48.8294577, lng: 2.3338498}, website: 'http://www.ateliervermeer.com/'},
					{name: 'Workshop Boubok', location: {lat: 48.8227633, lng: 2.3351342}, website: 'http://www.atelierboubok.com/'},
				];

				for (var i = 0; i < workshops.length; i++){
					var position = workshops[i].location;
					var title = workshops[i].name;
					var url = workshops[i].website;
					var marker = new google.maps.Marker({
						map: map,
						position: position,
						title: title,
						animation: google.maps.Animation.DROP,
						id: "item" + i,
						url: url,
					});
					markers.push(marker);

					marker.addListener('click', function(){
						console.log("log0");
						populateInfoWindow(this, workshopInfoWindow);
						// map.setCenter(this.position);
					});
					bounds.extend(markers()[i].position);
				}
				map.fitBounds(bounds);
			};

			
			function populateInfoWindow(marker, infowindow){

				if (infowindow.marker != marker){
					infowindow.setContent('');
					infowindow.marker = marker;
										
					infowindow.addListener('closeclick', function(){
						infowindow.setMarker = null;
						infowindow.marker = null;
					});

					var streetViewService = new google.maps.StreetViewService();
					var radius = 50;

					console.log("log1");

					function getStreetView(data, status){
						console.log("log2");
						if (status == google.maps.StreetViewStatus.OK){
							console.log("log3");
							var nearStreetViewLocation =  data.location.latLng;
							var heading = google.maps.geometry.spherical.computeHeading(
								nearStreetViewLocation, marker.position);
							infowindow.setContent('<div>' + marker.title +
								'</div> <div id="pano"></div> <br> <a href="' +
								marker.url + '" target="_blank"> Website </a>');
							var panoramaOptions = {
								position: nearStreetViewLocation,
								pov: {
									heading: heading,
									pitch: 30
								}
							};
							console.log("log4");
							var panorama = new google.maps.StreetViewPanorama(
								document.getElementById('pano'), panoramaOptions);
							console.log("loog5");
						}else {
							infowindow.setContent('<div>' + marker.title + '</div>' +
								'<div>No Street View Found</div>');
						};	
					};

					streetViewService.getPanoramaByLocation(marker.position, radius,
						getStreetView);
					infowindow.open(map, marker);
				}
			};

			function listViewModel(){
				var self = this;

				this.searched = ko.observable("");
				this.markersToShow = ko.computed(function(){
					var mToShow = [];
					for (i = 0; i < markers().length; i++){
						if (markers()[i].title.toLowerCase().indexOf(
							self.searched().toLowerCase()) >= 0){
							mToShow.push(markers()[i]);
							markers()[i].setVisible(true);
						} else {
							markers()[i].setVisible(false);
						};
					};
					return mToShow;
				});
			};

			ko.applyBindings(listViewModel);

				
		</script>
		<!-- Load the google maps js API asynchronously. -->
		<script async defer  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRzxua2TTljcai_uMvuR-bKGoFppUgEg8&libraries=geometry&v=3&callback=initMap"></script>
		<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
	</body>
</html>